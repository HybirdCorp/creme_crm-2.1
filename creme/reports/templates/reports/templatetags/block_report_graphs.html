{% load cycle from future %}{% load i18n %}
{% load creme_core_tags creme_block %}
{% load reports_tags %}
{% has_perm_to change object.report as has_perm %}{% has_perm_to admin 'reports' as admin_perm %}
<table class="table_detail_view ui-corner-all with-header {{state.classes}}" id="{{block_name}}">
    {% get_block_header colspan=6 %}
        <th class="label">{% get_block_title _('%s Graph') _('%s Graphs') 'graph_48.png' 'Graph' %}</th>
        <th class="actions">
            <div class="buttons">
                {% get_line_adder at_url '/reports/graph/{{object.id}}/add' with_label _("Add new graph") with_perms has_perm %}
            </div>
        </th>
    {% end_get_block_header %}
    <tbody class="collapsable">
        {% if page.paginator.count %}
            <tr class="header">
                <th class="block_header_line_dark action"></th>
                {% get_column_header _('Name') 'name' %}
                {% get_column_header _('Column abscissa') 'abscissa' %}
                {% get_column_header _('Column ordinate') 'ordinate' %}
                {% get_column_header _('Type') 'type' %}
                <th class="block_header_line_dark action">{% trans 'Actions' %}</th>
            </tr>
{% trans 'Edit' as edit_label %}{% trans "Can't edit" as noedit_label %}
{% trans 'Expand' as expand_label %}{% trans 'Reduce' as reduce_label %}
{% trans 'Create a block with this graph' as addblock_label %}{% trans "Can't create block"  as noaddblock_label %}
            {% for graph in page.object_list %}{% cycle "block_line_dark" "block_line_light" as row_color silent %}
                {% with hand=graph.hand %}
                    <tr class="content ui-creme-widget ui-creme-toggle toggle-collapsed widget-auto" widget="ui-creme-toggle"
                        ontoggle="$('.ui-creme-toggle.widget-ready#graph-{{graph.id}}').creme().widget().toggle(!collapsed);">
                        <td class="{{row_color}} action">
                            <div class="toggle-icon toggle-trigger" style="width:16px;height:16px;"
                                toggle-close-alt="{{expand_label}}" toggle-close-title="{{expand_label}}"
                                toggle-open-alt="{{reduce_label}}" toggle-open-title="{{reduce_label}}" />
                        </td>
                        <td class="{{row_color}}"><a href="{{graph.get_absolute_url}}">{{graph.name}}</a></td>
                        <td class="{{row_color}}{% if hand.abscissa_error %} td_error{% endif %}">{{hand.verbose_abscissa}}</td>
                        <td class="{{row_color}}{% if hand.ordinate_error %} td_error{% endif %}">{{hand.verbose_ordinate}}</td>
                        <td class="{{row_color}}">{{hand.verbose_name}}{% if graph.days %} ({{graph.days}}){% endif %}</td>
                        <td class="{{row_color}} action">
                            {% has_perm_to change graph as graph_edit_perm %}{% has_perm_to delete graph as graph_delete_perm %}
                            {% if graph_edit_perm %}
                                {% comment %}TODO : use a better method for plot cache issue. As temporary fix all cache is cleaned before popupNReload.{% endcomment %}
                                <a onclick="creme.reports.openGraphEdition('{{graph.id}}', {% get_block_reload_uri %});">
                                    <img src="{% creme_media_url 'images/edit_22.png' %}" alt="{{edit_label}}" title="{{edit_label}}" border="0">
                                </a>
                            {% else %}
                                <img class="forbidden" src="{% creme_media_url 'images/edit_22.png' %}" border="0" title="{{noedit_label}}" alt="{{noedit_label}}" />
                            {% endif %}
                            {% get_line_deletor at_url '/creme_core/entity/delete/multi' with_args "{'ids' : '{{graph.id}}' }" with_perms graph_delete_perm %}
                        </td>
                    </tr>
                    <tr class="ui-creme-widget ui-creme-toggle toggle-collapsed widget-auto" widget="ui-creme-toggle" id="graph-{{graph.id}}">
                        <td class="{{row_color}} toggle-target" colspan="6" toggle-close-colspan="6">
                            <div class="ui-creme-widget ui-creme-chainedselect widget-auto" widget="ui-creme-chainedselect"
                                style="margin:0px;padding:0px;border:0px;">
                                <input type="hidden" name="" class="ui-creme-input ui-creme-chainedselect"></input>
                                <ul class="ui-layout hbox" style="padding:2px;">
                                    {% report_chart_selector graph %}
                                    <li class="ui-creme-chainedselect-item" style="float:right;">
                                        {% if admin_perm %}
                                            <button onclick="creme.blocks.form('/reports/graph/{{graph.id}}/block/add', {blockReloadUrl:{% get_block_reload_uri %}}).open();">
                                                <img src="{% creme_media_url 'images/add_16.png' %}" alt="{{addblock_label}}" style="vertical-align:middle;"/>
                                                {{addblock_label}}
                                            </button>
                                        {% else %}
                                            <button class="forbidden" disabled="true" >
                                                <img src="{% creme_media_url 'images/add_16.png' %}" alt="{{noaddblock_label}}" style="vertical-align:middle;"/>
                                                {{noaddblock_label}}
                                            </button>
                                        {% endif %}
                                    </li>
                                </ul>
                                {% include 'reports/frags/graph_errors.html' %}
                                <div chained-name="plot" class="ui-creme-chainedselect-item">
                                    <div class="ui-widget-content ui-creme-widget ui-creme-plotselector" widget="ui-creme-plotselector"
                                        plot-data-url="/reports/graph/fetch_graph/{{graph.id}}/${sort}"
                                        plot-name="${graph}"
                                        style="width:100%;margin:0px;padding:0px;border:0px;">
                                        {% for name, chart in report_charts %}
                                            <script name="{{name}}" type="text/json">{% report_chart_json graph chart %}</script>
                                        {% endfor %}
                                        <div class="ui-widget-content ui-creme-widget ui-creme-jqueryplot ui-creme-resizable" widget="ui-creme-jqueryplot"
                                            savable="false" style="height:300px;padding:5px;border:0px;" format="creme.graphael.BargraphData">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                {% endwith %}
            {% endfor %}
        {% else %}
            <tr class="content empty">
                <td colspan="6" class="block_line_dark">{% trans 'No graphs registered for the moment' %}</td>
            </tr>
        {% endif %}
    </tbody>
    {% get_block_footer 6 %}
</table>