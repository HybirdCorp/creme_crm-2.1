{% extends "creme_core/detailview.html" %}
{% load i18n %}
{% load creme_core_tags creme_queryset reports_tags %}

{% block page_title %} - {% blocktrans %}Preview {{object}}{% endblocktrans %}{% endblock %}

{% comment %}
TODO: this is a hack to disable the Download <a> when datefilter is edited (because href becomes deprecated)
      so we have to rework this form in order to 'Download' to be integrated in the form & become a submit button too.
{% endcomment %}
{% block extrahead %}
    {{block.super}}
    <script type='text/javascript'>
        $(document).ready(function() {
            var controller = new creme.reports.PreviewController({{object.id}});
            controller.bind($('.report-preview'));
        });
    </script>
{% endblock %}

{% block before_content_1 %}
    <table class="table_header" cellpadding="0" cellspacing="0">
        <tr>
            <td class="logo"><img src="{% creme_media_url 'images/report_64.png' %}" alt="{% trans "Report" %}"/></td>
            <td class="title">
                <h1>
                    {% blocktrans with verbose_name=object|get_meta_value:"verbose_name"|capfirst title=object|capfirst %}Preview {{verbose_name}}: {{title}}{% endblocktrans %}
                </h1>
            </td>
            <td class="actions">
                <span>
                    <a href="{{object.get_absolute_url}}">
                        <img src="{% creme_media_url 'images/previous_64.png' %}" title="{% blocktrans with report=object %}Back to the detailview: '{{report}}'{% endblocktrans %}" alt="{% trans "Back" %}"/>
                    </a>&nbsp;
                    {% get_export_backends as export_backends %}
                    {% comment %}{% if export_backends|length > 2 %}{% endcomment %}
                    {% comment %}
                    <a class="report-dl" href="/reports/report/export/{{object.id}}/%s{{form.forge_url_data}}" onclick="event.preventDefault();creme.exports.exportAs($(this).attr('href'), {{export_backends}});">
                        <img src="{% creme_media_url 'images/document_csv_64.png' %}" title="{% blocktrans %}Download '{{object}}' as CSV file{% endblocktrans %}" alt="{% trans "Download CSV" %}"/>
                    </a>&nbsp;
                    {% endcomment %}
                    {% comment %}{% endif %}{% endcomment %}
                </span>
            </td>
        </tr>
    </table>
{% endblock %}

{% block content %}
<div class="report-preview">
    <div class='scrollable-block-container report-preview-header'>
        <form>
        {% include "reports/frags/report_preview_format.html" %}
        </form>
        <button type="button" name="generate">{% trans 'Preview' %}</button>
        <button type="button" name="download">{% trans 'Download' %}</button>
    </div>

    <div class='scrollable-block-container report-preview-data'>
        {% with object.get_children_fields_flat as flat_columns %}
        <table class="table_detail_view ui-corner-all with-header" >
            <thead>
                <tr>
                    <th colspan="100">{% blocktrans %}Preview of {{limit_to}} first entities{% endblocktrans %}</th>
                </tr>
            </thead>
            <tbody class="collapsable">
                <tr class="header">
                    {% comment %}
                        {% for column in object.columns.all|order_by:"order" %}
                            <th class="{% cycle "block_header_line_dark" "block_header_line_light" %}">{% get_column_header column %}</th>
                        {% endfor %}
                    {% endcomment %}
                    {% for column in flat_columns %}{% cycle "block_header_line_dark" "block_header_line_light" as row_color silent %}
                        <th class="{{row_color}}">{{column}}</th>
                    {% endfor %}
                </tr>
                {% for line in lines %}
                    <tr>
                        {% comment %}
                            This cannot be done in any other way, cycle won't reset after exiting the first loop
                            so an odd number of column will result in a chessboard. https://code.djangoproject.com/ticket/5908
                        {% endcomment %}
                        {% for val in line %}
                            <td class="{% if forloop.counter|divisibleby:2 %}block_line_light{%else%}block_line_dark{%endif%}">{{val}}&nbsp;</td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endwith %}
    </div>
</div>
{% endblock %}
