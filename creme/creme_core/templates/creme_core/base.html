{% load i18n %}
{% load creme_menu creme_core_tags creme_search creme_quickforms %}
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="{{ LANGUAGE_CODE }}" xml:lang="{{ LANGUAGE_CODE }}" {% if LANGUAGE_BIDI %}dir="rtl"{% endif %}>
<head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />{% comment %}<meta http-equiv="X-UA-Compatible" content="IE=8" />{% endcomment %}
    <title>{% block page_title %}{% endblock %}Creme CRM</title>
    <script type='text/javascript'>
        var THEME_NAME = "{{ THEME_NAME }}";
    </script>
    <!--
        Firebug for browsers without plugin/extension :
            - uncomment the following script
            - add debug="true" to <html> tag
    -->
    <!--script type="text/javascript" src="https://getfirebug.com/firebug-lite.js"></script-->
    {% include_creme_media "main.css" %}
    {% include "creme_core/frags/js_header.html" %}
    <link rel="shortcut icon" href="{% creme_media_url 'images/favicon.ico' %}" type="image/x-icon" />
    <style type="text/css">
        .fg-menu-container { z-index: 100; }
    </style>
    {% comment %} COMMENT on 27-01-2014
    <script type='text/javascript'>
        $(document).ready(function() {
           var document_width_onload  = $(document).width();
           var document_height_onload = $(document).height();

           function activeEventsMenu() {
                //'fast' transition makes bugs in chrome < 6.1
                $("#menu_collapse").mouseenter(function(e) {
                    $("#menu_expanded").show('fast');
                    $("#menu_collapse").hide('fast');
                });

                $("#menu_expanded").mouseleave(function(e) {
                    $("#menu_expanded").hide('fast');
                    $("#menu_collapse").show('fast');
                });
            }

            function desactiveEventsMenu() {
                $("#menu_collapse").unbind('mouseenter');
                $("#menu_expanded").unbind('mouseleave');
            }

            function resizePageElements(menu_width, expanded) {
                var top = $('#top');
                var content = $('#content');
                var footer = $('#footer');

                var margin_left = (expanded) ? menu_width + 5 + 'px' : menu_width;

                top.css('margin-left', margin_left);
                content.css('margin-left', margin_left);
                footer.css('margin-left', margin_left);

                var new_width = document_width_onload - menu_width;
                if(expanded) new_width -=10;
                top.width(new_width);
                content.width(new_width);
                footer.width(new_width);
            }

            //var content_height = $("#content").height()+$("#footer").height()+$("#top").height();//$('#footer').offset().top;//
            var logo_container_height = $('#logo_container').outerHeight();
            //var max_menu_height = content_height - logo_container_height;

            var height = $('#menu_expanded').height();

            $('#menu').menu({
                content: $('#tree_menu2').html(),
                flyOut: false,
                backLink: false,
                alwaysOpen:true,
                maxHeight: height,
                crumbDefaultText : '{% trans "Menu" %}',
                topLinkText : '{% trans "Back to Top" %}'
            });

            $('#menu').hide();
            $('.fg-menu-container')
                .appendTo('#menu_expanded')
                .css({'top': logo_container_height, 'bottom':'auto'});
                //.css({'top': logo_container_height, 'height':max_menu_height, 'bottom':'auto'});

            $("#menu_expanded").width($('.fg-menu-container').outerWidth());

            //Pin / Fixer le menu
            var onPin = function() {
                $(this).attr('src', '{% creme_media_url "images/unpin.png" %}');
                desactiveEventsMenu();
                resizePageElements($("#menu_expanded").outerWidth(), true);
                $.cookie('menu_creme', 'expanded', {expires: 7, path: '/', domain: '', secure: false});
            };

            //Unpin / Rendre le menu flottant
            var onUnpin = function() {
                $(this).attr('src', '{% creme_media_url "images/pin.png" %}');
                activeEventsMenu();
                resizePageElements($("#menu_collapse").outerWidth(), false);
                $.cookie('menu_creme', 'collapse', {expires: 7, path: '/', domain: '', secure: false});
            };

            // jquery 1.9 migration: toggle(handler, handler, ...) doesn't exist any more.
            if ($.cookie('menu_creme') == 'expanded') {
                $('.pinmenu').addClass('expanded')
                             .attr('src', '{% creme_media_url "images/unpin.png" %}');
                desactiveEventsMenu();
                $("#menu_expanded").show(resizePageElements($("#menu_expanded").outerWidth(), true));
                $("#menu_collapse").hide();
            } else {
                $('.pinmenu').attr('src', '{% creme_media_url "images/pin.png" %}');
                activeEventsMenu();
                $("#menu_expanded").hide();
                $("#menu_collapse").show(resizePageElements($("#menu_collapse").outerWidth(), false));
            }

            $('.pinmenu').on('click', function() {
                $(this).toggleClass('expanded');

                if ($(this).is('.expanded')) {
                    onPin();
                } else {
                    onUnpin();
                }
            });
      });
    </script>
    {% endcomment %}
    {% block extrahead %}{% endblock %}
    {% comment %} COMMENT on 27-01-2014
    <script type='text/javascript'>
      $(document).ready(function() {
        $("#menu_collapse").css('height', $(document).height());
        $("#menu_expanded").css('height', $(document).height());

        // jquery 1.9.x upgrade.
        $('#menu_expanded').on('menu-item-selected', '#active-menuitem a', function(e, menu){
            e.stopImmediatePropagation();
            var href = $(this).prop('href');
            //$.cookie('creme-menu-selected', href);
            creme.utils.goTo(href);
        });

        (function bind_scroll() {
            $(window).scroll(function(){
                var $menu = $('.fg-menu-container');

                if ($(this).scrollTop() > $('#logo_container').outerHeight()){
                    $menu.addClass('top_fixed');
                    $menu.css("left", -$(window).scrollLeft()+"px");
                }
                else{
                    $menu.removeClass('top_fixed');
                }
            });
        })();
      });

      window.onload = function() {
        //var content_height = $("#content").height()+$("#footer").height()+$("#top").height();//Is better but detailviews has float div so we have a very small height size
        /*var content_height = $(document).height();
        var logo_container_height = $('#logo_container').outerHeight();
        var max_menu_height = content_height - logo_container_height;

        $('.fg-menu-container').css({'top': logo_container_height, 'height':max_menu_height, 'bottom':'auto'});
        $('.fg-menu').css('height', max_menu_height*0.9);
        allUIMenus[0].setMaxHeight(max_menu_height*0.9);
        $('#menu_collapse').height(content_height*0.9);*/

        //var previous_selected = $.cookie('creme-menu-selected');

        var logo_container_height = $('#logo_container').outerHeight();//Webkit
        $('.fg-menu-container').css({'top': logo_container_height});//Webkit

        var previous_selected = window.location.pathname;

        if(previous_selected != null) {
            var $initial = $('#menu_expanded div.fg-menu-container').find('[href="'+previous_selected+'"]');
            var $ul = null;

            var li_stack = [];
            var more = true;

            var $li = $initial.parent('li');
            li_stack.push($li);

            var max_deep = 30;//I think the depth of the folder will not go more than 30 (which is already huge)
            var deep = 0;

            while(more && deep <= max_deep) { //Set max deep to avoid max recursion
                var ul = $li.parent('ul');
                $li = ul.parent('li');
                if($li.size() == 0) more = false;
                else li_stack.push($li);
                deep++;
            }

            var now = +new Date;

            for(var i = li_stack.length-1; i > 0; i--) {
                li_stack[i].find('a:first').click();
            }
        }
      };
      </script>
      {% endcomment %}
</head>
<body {% block bodyclass %}{% endblock %}>
    {% block side_menu %}
        <div id="menu_collapse" class="ui-corner-all menu_collapse">
            <img src="{% creme_media_url 'images/favicon.ico' %}"/>
            M<br/>
            E<br/>
            N<br/>
            U<br/>
            &nbsp;<br/>
            C<br/>
            R<br/>
            E<br/>
            M<br/>
            E<br/>
        </div>
        <div id="menu_expanded" class="menu_expanded">
            <div id="logo_container">
                <center>
                    <a href="/"><img src="{% creme_media_url logo_url %}" alt="Logo" class="logo pointer"/></a>
                </center>
            </div>
            {% block sidebar %}
                <a tabindex="0" href="#tree_menu2" class="fg-button fg-button-icon-right ui-widget ui-state-default ui-corner-all" id="menu">
                    Menu
                </a>
                <div id="tree_menu2" style="display:none;">
                 {% generate_treecreme_menu request %}
                </div>
            {% endblock %}
        </div>
    {% endblock %}

    {% block top_bar %}
        <div id="top" class="header">
            <div class="widget">
                {% comment %}{% trans 'Welcome,' %} <strong>{% if user.first_name %}{{user.first_name|escape}}{% else %}{{user.username}}{% endif %}</strong> ({% blocktrans %}Time zone: {{TIME_ZONE}}{% endblocktrans %}) -{% endcomment %}
                {% blocktrans %}Welcome, <strong>{{user}}</strong> (Time zone: {{TIME_ZONE}}){% endblocktrans %} -
                {% block userlinks %}
                    <a href="/creme_config/my_settings/">{% trans 'My settings' %}</a> -
                    {% comment %}<a href="/creme_core/clean/">{% trans 'Log out' %}</a> -{% endcomment %}
                    <a href="/creme_logout/">{% trans 'Log out' %}</a> -
                    <a href="/creme_core/entity/trash">
                        {% trans 'Trash' as trash_label %} <img src="{% creme_media_url 'images/delete_16.png' %}" alt="{{trash_label}}" title="{{trash_label}}" />{{trash_label}}
                    </a>
                {% endblock %}
            </div>
            <div class="widget major">
                {% get_search_panel %}
                {% get_quickforms_panel %}
            </div>
            {% comment %}<div class="widget last">{# :last-child is buggy so think to add last css class to the last element #}
                <a href="/"><img src="{% creme_media_url 'images/creme_header_50.png' %}" alt="Crème" border="0" /></a>
            </div>{% endcomment %}
            {% comment %}<div class="spacer"></div>{% endcomment %}
        </div>
    {% endblock %}

    <div id="content" class="main_content">
        {% block last_viewed_items %}
            {% get_last_items_menu request %}
        {% endblock %}

        {% block prefered_menu %}
            {% get_prefered_menu request %}
        {% endblock %}

        <div id="sub_content">
            {% block before_content_1 %}
            {% endblock %}

            {% block before_content_2 %}
            {% endblock %}

            {% block before_content_3 %}
            {% endblock %}

            {% block content %}
            {% endblock %}

            {% block after_content_1 %}
            {% endblock %}

            {% block after_content_2 %}
            {% endblock %}

            {% block after_content_3 %}
            {% endblock %}
        </div>
    </div>

    <div id="footer">
        <a href="http://hybird.org">{% trans "About Hybird" %}</a>&nbsp;&mdash;&nbsp;2009&hairsp;&ndash;&hairsp;2015 &nbsp;&nbsp;&nbsp;Creme v{{creme_version}} {% if django_version %}<i>&nbsp;&nbsp;&nbsp;(Django {{django_version}})</i>{% endif %}{% if THEME_VERBOSE_NAME %}&nbsp;&nbsp;&nbsp;{{ THEME_VERBOSE_NAME }}{% endif %}
    </div>
    <script type="text/javascript">
        $(document).ready(function(){
            creme.menu.sideMenu({
                title: '{% trans "Menu" %}',
                back: '{% trans "Back to Top" %}'
            });

            creme.blocks.bindEvents();
        });
    </script>
</body>
</html>
