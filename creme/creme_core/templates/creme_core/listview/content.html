{% load i18n creme_core_tags creme_widgets creme_listview creme_cells creme_ctype creme_query %}

{% with cells=header_filters.selected.filtered_cells %}

{# TODO : replace it by a div after complete refactor of button/link bindings #}
<form class="ui-creme-widget widget-auto ui-creme-listview" widget="ui-creme-listview"
      {% if whoami %}whoami="{{whoami}}"{% endif %} {% if not o2m %}multiple{% endif %}
      {% if is_popup_view %}reload-url="{% url 'creme_core__listview_popup' %}"{% endif %}>

{% listview_header_colspan cells=cells is_readonly=is_popup_view is_single_select=o2m as colspan %}
<div class="list-header-container{% if not is_popup_view %} sticky-container sticky-container-standalone{% endif %}">
    <div class="list-header sticks-horizontally">
        <div class="list-title-container">
            <span class="list-title">
                {{list_title}}
                {% if list_sub_title %}<span class="list-sub-title-separator">—</span><span class="list-sub-title">{{list_sub_title}}</span>{% endif %}
                {% if paginator.count > 0 %}
                <span class="list-title-stats">
                    {% if page_obj.start_index %}{# TODO: per paginator-class stats templatetag ?? #}
                    <span class="typography-parenthesis">(</span>{{page_obj.start_index}}&nbsp;–&nbsp;{{page_obj.end_index}} / {{paginator.count}}<span class="typography-parenthesis">)</span>
                    {% else %}
                    <span class="typography-parenthesis">(</span>{{paginator.count}}<span class="typography-parenthesis">)</span>
                    {% endif %}
                </span>
                {% endif %}
            </span>
            <div class="list-controls">
                <div class="list-control-group list-filters">
                    {% listview_entity_filters model=model user=user efilters=entity_filters show_buttons=is_popup_view|not_op %}
                </div>
                <div class="list-control-group list-views">
                    {% listview_header_filters model=model user=user hfilters=header_filters show_buttons=is_popup_view|not_op %}
                </div>
            </div>
        </div>
        <div class="list-header-buttons clearfix">
          {% if not is_popup_view %}
              {% listview_buttons model=model buttons=buttons %}
          {% endif %}
            <button class="with-icon do-search button-right" value="0" type="button" onclick="creme.lv_widget.findList(this).list_view('getSubmit')(this);">
                {% trans 'Search' context 'creme_core-verb' as label %}
                {% widget_icon name='search' label=label size='listview-button' %}
                <span>{{label}}</span>
            </button>
            <button class="clear-search button-right" value="1" type="button" {% if not search_form.search_q %}disabled="true"{% else %}onclick="creme.lv_widget.findList(this).list_view('getSubmit')(this, {search: 'clear'});"{% endif %}>
                {% trans 'Clear search' %}
            </button>
        </div>
    </div>
</div>

{# TODO: remove class "list_view" #}
<table id="list" class="list_view listview {% if is_popup_view %}listview-popup{% else %}listview-standalone{% endif %} {% if o2m %}listview-selection-single{% else %}listview-selection-multiple{% endif %}" cellpadding="0" cellspacing="0" data-total-count="{{paginator.count}}">
    <thead>
        <tr style="display:none;">
            <th colspan="{{colspan}}">{% ctype_for_model model as ctype %}
                <input value="{{list_view_state.sort_cell_key}}"     id="sort_key"      type="hidden" name="sort_key" />
                <input value="{{list_view_state.sort_order}}"        id="sort_order"    type="hidden" name="sort_order" />
                <input value=""                                      id="selected_rows" type="hidden" />
                <input value="{{o2m}}"                               id="o2m"           type="hidden" />
                <input value="{{extra_q.requested|query_serialize}}" id="q_filter"      type="hidden" name="q_filter" />
                <input value="{{ctype.id}}"                          id="ct_id"         type="hidden" name="ct_id" />
                {% block extra_buttons_hidden %}{% endblock %}
            </th>
        </tr>
        <tr class="columns_top">
            {% if not o2m %}<th class="choices"><center><input name="select_all" value="all" type="checkbox" title="{% trans 'Select all' %}"/></center></th>{% endif %}
            {% for cell in cells %}
                {% if cell.is_hidden %}
                    <th style="display:none;"></th>
                {% elif cell.type_id == 'actions' %}
                    <th class="actions">{% listview_header_actions cell=cell user=user %}</th>
                {% else %}{# NB: TMP - this header currently adds the css class cell.listview_css_class until semantic information is provided in the template context #}
                    {# TODO: should this header also add the cell.header_listview_css_class ? #}
                    <th data-column-key="{{cell.key}}" class="column{% if cell.key == list_view_state.sort_cell_key %} sorted{% if list_view_state.sort_order == 'DESC' %} reverse{% endif %}{% endif %}{% if cell|cell_is_sortable:cell_sorter_registry %} sortable{% endif %} cl_lv {{cell.listview_css_class}}"
                        colspan="{{cell|listview_column_colspan:is_popup_view}}">
                        <button type="button" {% if cell|cell_is_sortable:cell_sorter_registry %}title="{% blocktrans with cell.title as col_title %}Sort by {{col_title}}{% endblocktrans %}"{% else %}disabled="true"{% endif %}>
                            <div>
                                <span class="lv-sort-toggle-flag ui-icon {% if list_view_state.sort_order == 'DESC' %}ui-icon-triangle-1-s{% else %}ui-icon-triangle-1-n{% endif %}">&nbsp;</span>
                                <span class="lv-sort-toggle-title">{{cell.title}}</span>
                                <span class="lv-sort-toggle-flag ui-icon {% if list_view_state.sort_order == 'DESC' %}ui-icon-triangle-1-s{% else %}ui-icon-triangle-1-n{% endif %}">&nbsp;</span>
                            </div>
                        </button>
                    </th>
                {% endif %}
            {% endfor %}
        </tr>
        <tr id="list_thead_search" class="columns_bottom">
            {% if not o2m %}<th class="choices">&nbsp;</th>{% endif %}
            {% for cell in cells %}
                {% if cell.is_hidden %}
                    <th style="display:none;"></th>
                {% elif cell.type_id == 'actions' %}
                    <th class="actions" colspan="{{cell|listview_column_colspan:is_popup_view}}">
                        <span class='lv-search-title'>{% trans 'Quick search' %}</span>
                    </th>
                {% else %}
                    <th class="column {{cell.header_listview_css_class}} {{cell.listview_css_class}}{% if search_form.cleaned_data|get_by_index:cell.key %} search{% endif %}{% if cell.key == list_view_state.sort_cell_key %} sorted{% endif %}"{# {{widget.type}} {% if cell|cell_is_sortable:cell_sorter_registry %} sortable{% endif %} #}
                        colspan="{{cell|listview_column_colspan:is_popup_view}}">
                        {{search_form|get_by_index:cell.key}}
                    </th>
                {% endif %}
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for entity in page_obj.object_list %}
            <tr class="selectable{% cycle ' odd' '' %}" {% get_entity_html_attrs entity %}>
                {% if not o2m %}<td class="choices"><input name="select_one" value="{{entity.pk}}" type="checkbox" /></td>{% endif %}
                <td style="display:none;">
                    <input type="hidden" name="entity_id" value="{{entity.pk}}" />
                </td>
                {% for cell in cells %}
                    {% if cell.type_id == 'actions' %}
                        <td class="list_view_actions actions">{% listview_entity_actions cell=cell instance=entity user=user %}</td>
                    {% else %}
                        <td class="lv-cell lv-cell-content{% if cell.key == list_view_state.sort_cell_key %} sorted{% endif %} column cl_lv {{cell.listview_css_class}}" name="{{cell.key}}" {% if cell.is_hidden %}style="display:none;"{% endif %}>
                            {% cell_render cell=cell instance=entity user=user as cell_content %}
                            {% with data_type=cell.data_type %}
                            <div class="lv-cell-value{% if cell.is_multiline %} lv-cell-multiline-value{% endif %}{% if not cell_content %} lv-cell-empty-value{% endif %}" {% if data_type %}data-type="{{data_type}}"{% endif %}>
                                {{cell_content}}
                            </div>
                            {% endwith %}
                        </td>
                        {% if not is_popup_view %}
                        <td class="lv-cell lv-cell-action{% if cell.key == list_view_state.sort_cell_key %} sorted{% endif %} column cl_lv" {% if cell.is_hidden %}style="display:none;"{% endif %}>
                            {% listview_td_action_for_cell cell=cell instance=entity user=user %}
                        </td>
                        {% endif %}
                    {% endif %}
                {% endfor %}
            </tr>
            {% empty %}
            <tr>
                <td colspan="{{colspan}}">{% trans 'No entity exists / matches your search' %}</td>
            </tr>
        {% endfor %}
    </tbody>
    <tfoot>
        <tr>
            <td colspan="{{colspan}}">
                <div class='list-footer-container sticks-horizontally'>
                    <div class='list-footer-stats'>
                    {% with start_index=page_obj.start_index %}
                      {% if start_index %}{# TODO: per paginator-class footer-stats templatetag ?? (see similar question in title section #}
                        {% blocktrans with end_index=page_obj.end_index entities_count=paginator.count %}Recordings {{start_index}} - {{end_index}} on {{entities_count}}{% endblocktrans %}
                      {% else %}
                        {% blocktrans count entities_count=paginator.count %}{{entities_count}} recording{% plural %}{{entities_count}} recordings{% endblocktrans %}
                      {% endif %}
                    {% endwith %}
                    </div>

                  {% if paginator.num_pages > 1 %}
                    {% listview_pager page_obj %}
                  {% else %}
                    <div class='listview-pagination'></div>
                  {% endif %}

                    <div class='list-footer-page-selector'>
                        <label for="id_page_selector_rows">{% trans 'Nb / Page' %} :</label>
                        <select id="id_page_selector_rows" name="rows" onchange="creme.lv_widget.findList(this).list_view('getSubmit')(this);">
                        {% with rows=paginator.per_page %}
                            {% for size_option in page_sizes %}<option value="{{size_option}}"{% if rows == size_option %} selected{% endif %}>{{size_option}}</option>{% endfor %}
                        {% endwith %}
                        </select>
                    </div>
                </div>
            </td>
        </tr>
    </tfoot>
</table>
</form>
{% endwith %}
