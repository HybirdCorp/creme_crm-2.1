{% load i18n creme_core_tags creme_widgets creme_listview creme_cells %}
{% load creme_block %} {# REMOVE !! #}

{% with cells=header_filters.selected.filtered_cells %}

{# TODO : replace it by a div after complete refactor of button/link bindings #}
<form class="ui-creme-widget widget-auto ui-creme-listview" widget="ui-creme-listview"
      {% if whoami %}whoami="{{whoami}}"{% endif %} {% if not o2m %}multiple{% endif %}
      {% if is_popup_view %}reload-url="{% url 'creme_core__listview_popup' %}"{% endif %}>
{% listview_header_colspan cells=cells is_readonly=is_popup_view is_single_select=o2m as colspan %}

<table id="list" class="list_view" cellpadding="0" cellspacing="0">
    <thead>
        <tr class="title">
            <th colspan="{{colspan}}"><h2>{{list_title}}</h2></th>
        </tr>
        {% if list_sub_title %}
            <tr class="sub_title">
                <th colspan="{{colspan}}"><h4>{{list_sub_title}}</h4></th>
            </tr>
        {% endif %}
        <tr class="lines_modifiers">
            <th colspan="{{colspan}}">
                <table>
                    <tbody>
                        <tr>
                            <th class="filters">{% get_listview_entity_filters %}</th>
                            <th class="views">{% get_listview_headerfilters %}</th>
                        </tr>
                    </tbody>
                </table>
            </th>
        </tr>
        <tr id="list_thead_toolbar" class="toolbar">
            <th colspan="{{colspan}}">
                {% if not is_popup_view %}
                    {% has_perm_to create model as creation_perm %}{% has_perm_to export model as export_perm %}
                    {% if add_url %}
                        <a {% if creation_perm %}href="{{add_url}}"{% else %}class="forbidden" title="{% trans "Forbidden" %}"{% endif %}>
                            {% trans "New" as img_title %}<img border="0" src="{% creme_media_url 'images/add_22.png' %}" alt="{{img_title}}" title="{{img_title}}"/>{{model.creation_label}}
                        </a>&nbsp;
                    {% endif %}
                    {% get_export_backends as export_backends %}
                    {% if export_backends|length > 2 %}{% url 'creme_core__dl_listview' as dl_url %}
{#                        <a {% if export_perm %}href="/creme_core/list_view/download/{{content_type_id}}/%s?list_url={{request.path}}" onclick="event.preventDefault();creme.exports.exportAs($(this).attr('href'), {{export_backends}});"{% else %}class="forbidden" title="{% trans "Forbidden" %}"{% endif %}> #}
                        <a {% if export_perm %}href="{{dl_url}}?ct_id={{content_type_id}}&list_url={{request.path}}" onclick="event.preventDefault();creme.exports.exportAs($(this).attr('href'), {{export_backends}}, 'type');"{% else %}class="forbidden" title="{% trans "Forbidden" %}"{% endif %}>
                            {% trans "Download" as label %}<img border="0" src="{% creme_media_url 'images/document_csv_22.png' %}" alt="{{label}}" title="{{label}}"/>{{label}}
                        </a>&nbsp;
{#                        <a {% if export_perm %}href="/creme_core/list_view/download_header/{{content_type_id}}/%s?list_url={{request.path}}" onclick="event.preventDefault();creme.exports.exportAs($(this).attr('href'), {{export_backends}});"{% else %}class="forbidden" title="{% trans "Forbidden" %}"{% endif %}> #}
                        <a {% if export_perm %}href="{{dl_url}}?ct_id={{content_type_id}}&list_url={{request.path}}&header=true" onclick="event.preventDefault();creme.exports.exportAs($(this).attr('href'), {{export_backends}}, 'type');"{% else %}class="forbidden" title="{% trans "Forbidden" %}"{% endif %}>
                            {% trans "Download header" as label %}<img border="0" src="{% creme_media_url 'images/document_csv_22.png' %}" alt="{{label}}" title="{{label}}"/>{{label}}
                        </a>&nbsp;
                    {% endif %}
                    {% ctype_is_registered_for_import content_type as can_import %}
                    {% if can_import %}
                        {% get_import_backends as import_backends %}
                        {% if import_backends|length > 2 %}
{#                          <a {% if creation_perm %}href="/creme_core/list_view/import/{{content_type_id}}?list_url={{request.path}}"{% else %}class="forbidden" title="{% trans "Forbidden" %}"{% endif %}> #}
{#                            <a {% if creation_perm %}href="/creme_core/mass_import/{{content_type_id}}"{% else %}class="forbidden" title="{% trans "Forbidden" %}"{% endif %}> #}
                            <a {% if creation_perm %}href="{% url 'creme_core__mass_import' content_type_id %}"{% else %}class="forbidden" title="{% trans "Forbidden" %}"{% endif %}>
                                {% trans "Import" as label %}<img border="0" src="{% creme_media_url 'images/document_csv_22.png' %}" alt="{{label}}" title="{{label}}"/>{{label}}
                            </a>&nbsp;
                        {% endif %}
                    {% endif %}
{#                    <a href="/creme_core/list_view/batch_process/{{content_type_id}}?list_url={{request.path}}"> #}
                    <a href="{% url 'creme_core__batch_process' content_type_id %}?list_url={{request.path}}">
                        {% trans "Batch process" as label %}<img border="0" src="{% creme_media_url 'images/batch_process_22.png' %}" alt="{{label}}" title="{{label}}"/>{{label}}
                    </a>&nbsp;
                {% endif %}
                <button class="listview-header-button clear-search" value="1" type="button" {% if not search %} disabled="true" {% else %} onclick="$(this.form).list_view('getSubmit')(this, {search: 'clear'});" {% endif %}>{% trans "Clean the search" %}</button>&nbsp;
                <button class="listview-header-button-with-icon do-search" value="0" type="button" onclick="$(this.form).list_view('getSubmit')(this);">
                    {% trans "Search" context "creme_core-verb" as label %}
                    <div>
                        <img border="0" src="{% creme_media_url 'images/search_22.png' %}" alt="{{label}}" title="{{label}}"/>
                        <span>{{label}}</span>
                    </div>
                </button>
                {% block extra_buttons %}{% endblock %}
                {% if extra_bt_templates|isiterable %}
                    {% for templ in extra_bt_templates %}
                        {% include templ %}
                    {% endfor %}
                {% endif %}
            </th>
        </tr>
        <tr style="display:none;">
            <th colspan="{{colspan}}">
                <input value="{{list_view_state.sort_field}}" id="sort_field"    type="hidden" name="sort_field" />
                <input value="{{list_view_state.sort_order}}" id="sort_order"    type="hidden" name="sort_order" />
                <input value=""                               id="selected_rows" type="hidden" />
                <input value="{{o2m}}"                        id="o2m"           type="hidden" />
                <input value="{{q_filter}}"                   id="q_filter"      type="hidden" name="q_filter" />
                <input value="{{content_type_id}}"            id="ct_id"         type="hidden" name="ct_id" />
                {% block extra_buttons_hidden %}{% endblock %}
            </th>
        </tr>
        <tr class="columns_top">
            {% if not o2m %}<th class="choices">&nbsp;</th>{% endif %}
            {% for cell in cells %}
                {% if cell.is_hidden %}
                    <th style="display:none;"></th>
                {% elif cell.type_id == 'actions' %}
                    <th class="actions"></th>
                {% else %}
                    <th class="{% if cell.key == list_view_state.sort_field %}sorted {% if list_view_state.sort_order == '-' %} reverse{% endif %}{% endif %} column{% if cell.key in research_cellkeys %} search{% endif %}{% if cell.sortable %} sortable{% endif %} cl_lv"
                        colspan="{{cell|listview_column_colspan:is_popup_view}}">
                        <button type="button" {% if cell.sortable %}title="{% blocktrans with cell.title as col_title %}Sort by {{col_title}}{% endblocktrans %}" onclick="creme.lv_widget.handleSort('#sort_field', '#sort_order', '{{cell.key}}', this, $(this.form).list_view('getSubmit'));"{% else %} disabled="true" {% endif %}>
                            <div>
                                <span class="lv-sort-toggle-flag ui-icon {% if list_view_state.sort_order == '-' %}ui-icon-triangle-1-s{% else %}ui-icon-triangle-1-n{% endif %}">&nbsp;</span>
                                <span class="lv-sort-toggle-title">{{cell.title}}</span>
                                <span class="lv-sort-toggle-flag ui-icon {% if list_view_state.sort_order == '-' %}ui-icon-triangle-1-s{% else %}ui-icon-triangle-1-n{% endif %}">&nbsp;</span>
                            </div>
                        </button>
                    </th>
                {% endif %}
            {% endfor %}
        </tr>
        {% get_listview_columns_header %}
    </thead>
    <tbody>
        {% for entity in entities.object_list %}
            <tr class="selectable{% cycle ' odd' '' %}" {% get_entity_html_attrs entity %}>
                {% if not o2m %}<td class="choices"><input name="select_one" value="{{entity.pk}}" type="checkbox" /></td>{% endif %}
                <td style="display:none;">
                    <input type="hidden" name="entity_id" value="{{entity.pk}}" />
                </td>
                {% for cell in cells %}
                    {% if cell.type_id == 'actions' and show_actions %}
                        <td title="actions" class="list_view_actions actions">{% get_entity_actions entity %}</td>
                    {% else %}
                        <td class="lv-cell lv-cell-content {% if cell.key == list_view_state.sort_field %}sorted{% endif %} column cl_lv {{cell.listview_css_class}}" title="" name="{{cell.key}}" {% if cell.is_hidden %}style="display:none;"{% endif %}>
                            <div>{% cell_render cell=cell instance=entity user=user %}</div>
                        </td>
                        {% if not is_popup_view %}
                        <td class="lv-cell lv-cell-action {% if cell.key == list_view_state.sort_field %}sorted{% endif %} column cl_lv" {% if cell.is_hidden %}style="display:none;"{% endif %}>
                            {% get_field_editor on entity_cell cell for entity %}
                        </td>
                        {% endif %}
                    {% endif %}
                {% endfor %}
            </tr>
            {% empty %}
            <tr>
                <td colspan="{{colspan}}">{% trans "No entity exists / matches your search" %}</td>
            </tr>
        {% endfor %}
    </tbody>
    <tfoot>
        <tr>
            <td colspan="{{colspan}}">
                <table border="0" width="100%">
                    <tbody>
                        <tr>
                            {% get_listview_pagination entities %}
                            <td class="page_selector">
                                <label for="id_page_selector_rows">{% trans "Nb / Page" %} :</label>
                                <select id="id_page_selector_rows" name="rows" onchange="$(this.form).list_view('getSubmit')(this);">
                                    {% with entities.paginator.per_page as rows %}
                                        {% for size_option in page_sizes %}
                                            <option value="{{size_option}}" {% if rows == size_option %}selected{% endif %}>{{size_option}}</option>
                                        {% endfor %}
                                    {% endwith %}
                                </select>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </td>
        </tr>
    </tfoot>
</table>
</form>
{% endwith %}
