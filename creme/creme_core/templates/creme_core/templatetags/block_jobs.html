{% load i18n creme_block %}

{% if not request.is_ajax %}
    <script type="text/javascript">
        $(document).ready(function() {
            var first_load_ok = false;

            $('#content').on('block-ready', function(e, block) {
                if (first_load_ok) return;

                if (block.attr('id') == '{{block_name}}') {
                    first_load_ok = true;
                    creme.jobs.checkJobManager('{{block_name}}', false);
                }
            });
        });
    </script>
{% endif %}

{% with colspan=8 %}
<table class="table_detail_view ui-corner-all with-header {{state.classes}}" id="{{block_name}}">
    {% get_block_header colspan=colspan %}
        <th class="label">{% get_block_title _('%s Job') _('%s Jobs') %}</th>
        <th class="actions">
            <div class="buttons"></div>
        </th>
    {% end_get_block_header %}
    <tbody class="collapsable">
        <tr class="header global_error" style="display: none;">
            <th class="td_error" colspan="{{colspan}}"></th>
        </tr>
        {% if page.paginator.count %}
            <tr class="header">
                <th class="block_header_line_dark">{% trans "App" %}</th>
                <th class="block_header_line_dark">{% trans "Type" %}</th>
                <th class="block_header_line_dark">{% trans "Owner" %}</th>
                <th class="block_header_line_dark">{% trans "Periodicity" %}</th>
                <th class="block_header_line_dark">{% trans "Last run" %}</th>
                <th class="block_header_line_dark">{% trans "Status" %}</th>
                <th class="block_header_line_dark">{% trans "Enabled" %}</th>
                <th class="block_header_line_dark">{% trans "Actions" %}</th>
            </tr>
            {% if user_jobs_count >= MAX_JOBS_PER_USER %}
                <tr class="header">
                    <th class="help_box" colspan="{{colspan}}">
                        {% if user_jobs_count == 1 %}
                            {% trans "You must delete your job in order to create a new one." %}
                        {% else %}
                            {% trans "You must delete one of your jobs in order to create a new one." %}
                        {% endif %}
                    </th>
                </tr>
            {% endif %}
            {% for job in page.object_list %}{% cycle "block_line_dark" "block_line_light" as row_color silent %}
                <tr class="content">
                    <td class="{{row_color}}">{{job.type.app_config.verbose_name}}</td>
                    <td class="{{row_color}}">{{job.type}}</td>
                    <td class="{{row_color}}">{{job.user|default:''}}</td>
                    <td class="{{row_color}}">
                        {% if job.type.periodic != NOT_PERIODIC %}
                            <ul>
                                <li>{% trans "Reference run" %}: {{job.reference_run}}</li>
                                <li>{% trans "Every" %}: {{job.real_periodicity}}</li>
                            </ul>
                        {% endif %}
                    </td>
                    <td class="{{row_color}}">{{job.last_run|default:''}}</td>
                    <td class="{{row_color}}" data-job-id="{{job.id}}" data-job-status="{{job.status}}" data-job-ack-errors="{{job.ack_errors}}">{{job.get_status_display}}</td>
                    <td class="{{row_color}}">
                        {% if not job.user %}
                            <input type="radio" name="enable_{{job.id}}" value="false" {% if not user.is_superuser %}disabled="true"{% endif %} {% if job.enabled %}checked{% else %}onmousedown="creme.blocks.ajaxPOSTQuery('/creme_core/job/{{job.id}}/enable', {blockReloadUrl: {% get_block_reload_uri %}}).start()"{% endif %}>{% trans "Yes" %}
                            <input type="radio" name="enable_{{job.id}}" value="true"  {% if not user.is_superuser %}disabled="true"{% endif %} {% if not job.enabled %}checked{% else %}onmousedown="creme.blocks.ajaxPOSTQuery('/creme_core/job/{{job.id}}/disable', {blockReloadUrl: {% get_block_reload_uri %}}).start()"{% endif %}>{% trans "No" %}
                        {% endif %}
                    </td>
                    <td class="{{row_color}} action">
                        {% if job.get_config_form_class %}
                             {% get_line_editor at_url job.get_edit_absolute_url with_perms 1 %}
                        {% endif %}
                        {% get_line_viewer at_url job.get_absolute_url with_label "" with_perms 1 %}
                        {% if job.is_finished and job.user_id %}
                            {% comment %}TODO: job.get_delete_absolute_url {% endcomment %}
                            {% get_line_deletor at_url '/creme_core/job/{{job.pk}}/delete' with_args "{'id':{{job.pk}} }" with_perms 1 %}
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        {% else %}
            <tr class="content empty">
                <td class="block_line_dark">{% trans "No job for the moment" %}</td>
            </tr>
        {% endif %}
    </tbody>
    {% get_block_footer colspan %}
</table>
{% endwith %}